name: Demo Expiration Check

on:
  schedule:
    # Run daily at 00:00 UTC to check for expiration
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check expiration date
        id: check
        run: |
          EXPIRATION_DATE="2025-12-21"
          CURRENT_DATE=$(date -u +%Y-%m-%d)
          
          echo "Current date: $CURRENT_DATE"
          echo "Expiration date: $EXPIRATION_DATE"
          
          if [[ "$CURRENT_DATE" > "$EXPIRATION_DATE" ]]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "Demo has EXPIRED"
          else
            echo "expired=false" >> $GITHUB_OUTPUT
            DAYS_LEFT=$(( ($(date -d "$EXPIRATION_DATE" +%s) - $(date -d "$CURRENT_DATE" +%s)) / 86400 ))
            echo "days_remaining=$DAYS_LEFT" >> $GITHUB_OUTPUT
            echo "Demo is active. $DAYS_LEFT days remaining."
          fi
          
      - name: Create expiration notice
        if: steps.check.outputs.expired == 'true'
        run: |
          cat > EXPIRED_NOTICE.md << 'EOF'
          # âš ï¸ DEMO EXPIRED
          
          This demonstration project expired on 2025-12-21.
          
          **Why did this expire?**
          Demo projects are time-limited to ensure users discover current Snowflake syntax and best practices. Code older than 30 days may reference deprecated features or outdated patterns.
          
          **What should I do?**
          1. Check for an updated version of this demo
          2. Review Snowflake's latest documentation for current best practices
          3. Contact SE Community for guidance on modern implementations
          
          **Repository Status:**
          This repository has been automatically archived and made private to prevent discovery of potentially outdated code.
          
          ---
          *Expiration enforced by automated workflow (expire-demo.yml)*
          EOF
          
      - name: Commit expiration notice
        if: steps.check.outputs.expired == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add EXPIRED_NOTICE.md
          git commit -m "docs: add expiration notice (automated)"
          git push
          
      - name: Archive repository (placeholder)
        if: steps.check.outputs.expired == 'true'
        run: |
          echo "âš ï¸ MANUAL ACTION REQUIRED:"
          echo "This workflow cannot automatically archive the repository."
          echo ""
          echo "Repository owner must:"
          echo "1. Go to Settings > General > Danger Zone"
          echo "2. Click 'Archive this repository'"
          echo "3. Click 'Change visibility' to make private"
          echo ""
          echo "Alternatively, use GitHub CLI or API with appropriate permissions:"
          echo "gh repo archive ${{ github.repository }}"
          echo "gh repo edit ${{ github.repository }} --visibility private"
          
      - name: Create issue for manual archival
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Demo Expired - Manual Archival Required',
              body: `## Demo Expiration Alert
              
              This demo project has **EXPIRED** as of 2025-12-21.
              
              ### Required Actions
              
              1. **Archive Repository**
                 - Go to Settings > General > Danger Zone
                 - Click "Archive this repository"
                 
              2. **Make Private**
                 - Settings > General > Danger Zone
                 - Click "Change visibility" â†’ Private
                 
              ### Why This Matters
              
              Expired demos may contain outdated Snowflake syntax or deprecated features. Archiving prevents users from discovering stale code while preserving it for reference.
              
              ### Alternative: GitHub CLI
              
              \`\`\`bash
              gh repo archive ${context.repo.owner}/${context.repo.repo}
              gh repo edit ${context.repo.owner}/${context.repo.repo} --visibility private
              \`\`\`
              
              ---
              *This issue was automatically created by the expiration workflow.*`,
              labels: ['expired', 'maintenance']
            });
            console.log('Created issue:', issue.data.html_url);
            
      - name: Warning for approaching expiration
        if: steps.check.outputs.expired == 'false' && steps.check.outputs.days_remaining != '' && steps.check.outputs.days_remaining < 8
        run: |
          echo "âš ï¸ WARNING: Demo expires in ${{ steps.check.outputs.days_remaining }} days"
          echo "Prepare for archival and visibility change after 2025-12-21"
